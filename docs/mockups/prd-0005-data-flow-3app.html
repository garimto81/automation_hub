<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PRD-0005: 3-App 데이터 흐름</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff;
            padding: 16px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            font-size: 18px;
            font-weight: 700;
            color: #1A4D8C;
            margin-bottom: 8px;
            text-align: center;
        }
        .subtitle {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-bottom: 24px;
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        .phase-legend {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 24px;
        }
        .phase-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .phase-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }
        .phase-label {
            font-size: 11px;
            color: #666;
            text-align: center;
        }
        .p1 { background: #1565C0; }
        .p2 { background: #388E3C; }
        .p3 { background: #EF6C00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>3-App 데이터 흐름</h1>
        <div class="subtitle">Phase 1 (입력) -> Phase 2 (관리) -> Phase 3 (출력)</div>

        <div class="mermaid">
sequenceDiagram
    autonumber
    participant GFX as GFX PC
    participant NAS as NAS<br/>(JSON)
    participant App1 as App 1<br/>(Watcher)
    participant DB as PostgreSQL
    participant App2 as App 2<br/>(Frontend)
    participant User as 운영자
    participant App3 as App 3<br/>(Nexrender)
    participant OUT as NAS<br/>(Output)

    rect rgb(227, 242, 253)
        Note over GFX,App1: Phase 1: 데이터 입력
        GFX->>NAS: JSON 파일 생성
        NAS-->>App1: 파일 감지 (2초 polling)
        App1->>App1: JSON 파싱
        App1->>DB: Hand INSERT
    end

    rect rgb(232, 245, 233)
        Note over DB,User: Phase 2: 데이터 관리
        User->>App2: 대시보드 접속
        App2->>DB: Hand 목록 조회
        DB-->>App2: hands 데이터
        App2-->>User: UI 표시
        User->>App2: 핸드 선택 + 렌더링 요청
        App2->>DB: RenderInstruction INSERT<br/>(status=pending)
    end

    rect rgb(255, 243, 224)
        Note over DB,OUT: Phase 3: 렌더링 출력
        App3->>DB: pending 작업 polling (5초)
        DB-->>App3: RenderInstruction
        App3->>DB: status=processing 업데이트
        App3->>App3: AE 렌더링 실행
        App3->>OUT: 결과물 저장 (.mov/.mp4)
        App3->>DB: status=completed 업데이트
        App3->>DB: RenderOutput INSERT
    end

    User->>App2: 출력물 확인
    App2->>DB: RenderOutput 조회
    DB-->>App2: 결과 목록
    App2-->>User: 완료 표시
        </div>

        <div class="phase-legend">
            <div class="phase-item">
                <div class="phase-number p1">1</div>
                <div class="phase-label">데이터 입력<br/>(App 1)</div>
            </div>
            <div class="phase-item">
                <div class="phase-number p2">2</div>
                <div class="phase-label">데이터 관리<br/>(App 2)</div>
            </div>
            <div class="phase-item">
                <div class="phase-number p3">3</div>
                <div class="phase-label">렌더링 출력<br/>(App 3)</div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#E3F2FD',
                primaryTextColor: '#1A4D8C',
                primaryBorderColor: '#1A4D8C',
                actorBkg: '#E3F2FD',
                actorBorder: '#1A4D8C',
                actorTextColor: '#1A4D8C',
                signalColor: '#666',
                signalTextColor: '#333',
                labelBoxBkgColor: '#FFF8E1',
                labelBoxBorderColor: '#F57C00',
                labelTextColor: '#333',
                loopTextColor: '#666',
                noteBkgColor: '#FFF8E1',
                noteBorderColor: '#F57C00',
                noteTextColor: '#333',
                fontSize: '12px'
            },
            sequence: {
                diagramMarginX: 20,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 120,
                height: 50,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: false
            }
        });
    </script>
</body>
</html>
